<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿å­˜åŠŸèƒ½è¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #005a87;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 3px;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ä¿å­˜åŠŸèƒ½è¨ºæ–·å·¥å…·</h1>
    
    <div class="test-section">
        <h2>1. ç’°å¢ƒæª¢æŸ¥</h2>
        <button class="btn" onclick="checkEnvironment()">æª¢æŸ¥ç’°å¢ƒ</button>
        <div id="env-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. API é€£æ¥æ¸¬è©¦</h2>
        <button class="btn" onclick="testApiConnection()">æ¸¬è©¦ API é€£æ¥</button>
        <div id="api-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. ç²å–æ¨¡æ¿æ¸¬è©¦</h2>
        <button class="btn" onclick="testGetTemplates()">æ¸¬è©¦ç²å–æ¨¡æ¿</button>
        <div id="get-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. ä¿å­˜æ¨¡æ¿æ¸¬è©¦</h2>
        <button class="btn" onclick="testSaveTemplate()">æ¸¬è©¦ä¿å­˜æ¨¡æ¿</button>
        <div id="save-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>5. å®Œæ•´è¨ºæ–·</h2>
        <button class="btn" onclick="runFullDiagnostic()">åŸ·è¡Œå®Œæ•´è¨ºæ–·</button>
        <div id="diagnostic-result" class="result"></div>
    </div>

    <script>
        let diagnosticResults = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            diagnosticResults.push({ message: logMessage, type });
            return logMessage;
        }
        
        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = content;
            element.className = `result ${type}`;
        }
        
        async function checkEnvironment() {
            const resultDiv = document.getElementById('env-result');
            let results = [];
            
            try {
                // æª¢æŸ¥ç€è¦½å™¨ç’°å¢ƒ
                results.push(`âœ… ç€è¦½å™¨: ${navigator.userAgent}`);
                results.push(`âœ… èªè¨€: ${navigator.language}`);
                results.push(`âœ… ç·šä¸Šç‹€æ…‹: ${navigator.onLine ? 'ç·šä¸Š' : 'é›¢ç·š'}`);
                
                // æª¢æŸ¥ API æ”¯æ´
                results.push(`âœ… Fetch API: ${typeof fetch !== 'undefined' ? 'æ”¯æ´' : 'ä¸æ”¯æ´'}`);
                results.push(`âœ… JSON: ${typeof JSON !== 'undefined' ? 'æ”¯æ´' : 'ä¸æ”¯æ´'}`);
                
                // æª¢æŸ¥ç•¶å‰ URL
                results.push(`âœ… ç•¶å‰ URL: ${window.location.href}`);
                results.push(`âœ… å”è­°: ${window.location.protocol}`);
                results.push(`âœ… ä¸»æ©Ÿ: ${window.location.host}`);
                results.push(`âœ… è·¯å¾‘: ${window.location.pathname}`);
                
                showResult('env-result', results.join('\n'), 'success');
                log('ç’°å¢ƒæª¢æŸ¥å®Œæˆ', 'success');
                
            } catch (error) {
                showResult('env-result', `âŒ ç’°å¢ƒæª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
                log(`ç’°å¢ƒæª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        async function testApiConnection() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.textContent = 'æ¸¬è©¦ä¸­...';
            
            try {
                // æ¸¬è©¦ä¸åŒçš„ API ç«¯é»
                const endpoints = [
                    'api/save-template.php',
                    'api/get-templates.php',
                    '/api/save-template.php',
                    '/api/get-templates.php'
                ];
                
                let results = [];
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(endpoint, {
                            method: 'OPTIONS'
                        });
                        results.push(`âœ… ${endpoint}: ${response.status} ${response.statusText}`);
                    } catch (error) {
                        results.push(`âŒ ${endpoint}: ${error.message}`);
                    }
                }
                
                showResult('api-result', results.join('\n'), 'info');
                log('API é€£æ¥æ¸¬è©¦å®Œæˆ', 'info');
                
            } catch (error) {
                showResult('api-result', `âŒ API æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                log(`API æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        async function testGetTemplates() {
            const resultDiv = document.getElementById('get-result');
            resultDiv.textContent = 'æ¸¬è©¦ä¸­...';
            
            try {
                const response = await fetch('api/get-templates.php');
                const data = await response.json();
                
                if (data.success) {
                    showResult('get-result', 
                        `âœ… æˆåŠŸç²å–æ¨¡æ¿\n` +
                        `ğŸ“Š æ¨¡æ¿æ•¸é‡: ${data.data.templates.length}\n` +
                        `ğŸ“… æœ€å¾Œæ›´æ–°: ${data.data.metadata.lastUpdated}\n` +
                        `ğŸ”§ ç‰ˆæœ¬: ${data.data.metadata.version}`, 
                        'success'
                    );
                    log('ç²å–æ¨¡æ¿æ¸¬è©¦æˆåŠŸ', 'success');
                } else {
                    showResult('get-result', `âŒ ç²å–å¤±æ•—: ${data.message}`, 'error');
                    log(`ç²å–æ¨¡æ¿å¤±æ•—: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('get-result', `âŒ è«‹æ±‚å¤±æ•—: ${error.message}`, 'error');
                log(`ç²å–æ¨¡æ¿è«‹æ±‚å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        async function testSaveTemplate() {
            const resultDiv = document.getElementById('save-result');
            resultDiv.textContent = 'æ¸¬è©¦ä¸­...';
            
            const testTemplate = {
                id: 'DEBUG_TEST_' + Date.now(),
                code: 'DEBUG_TEST_' + Date.now(),
                category: 'ic',
                title: {
                    zh: 'è¨ºæ–·æ¸¬è©¦æ¨¡æ¿',
                    en: 'Debug Test Template'
                },
                description: {
                    zh: 'é€™æ˜¯ä¸€å€‹è¨ºæ–·æ¸¬è©¦ç”¨çš„æ¨¡æ¿',
                    en: 'This is a debug test template'
                },
                content: {
                    zh: 'æ¸¬è©¦å…§å®¹ {{1}}',
                    en: 'Test content {{1}}'
                },
                status: 'active'
            };
            
            try {
                const response = await fetch('api/save-template.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testTemplate)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult('save-result', 
                        `âœ… ä¿å­˜æˆåŠŸ\n` +
                        `ğŸ†” æ¨¡æ¿ ID: ${data.data.templateId}\n` +
                        `ğŸ“Š ç¸½æ¨¡æ¿æ•¸: ${data.data.totalTemplates}\n` +
                        `ğŸ“… æ›´æ–°æ™‚é–“: ${data.data.lastUpdated}\n` +
                        `ğŸ’¬ è¨Šæ¯: ${data.message}`, 
                        'success'
                    );
                    log('ä¿å­˜æ¨¡æ¿æ¸¬è©¦æˆåŠŸ', 'success');
                } else {
                    showResult('save-result', `âŒ ä¿å­˜å¤±æ•—: ${data.message}`, 'error');
                    log(`ä¿å­˜æ¨¡æ¿å¤±æ•—: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult('save-result', `âŒ è«‹æ±‚å¤±æ•—: ${error.message}`, 'error');
                log(`ä¿å­˜æ¨¡æ¿è«‹æ±‚å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        async function runFullDiagnostic() {
            const resultDiv = document.getElementById('diagnostic-result');
            resultDiv.textContent = 'åŸ·è¡Œå®Œæ•´è¨ºæ–·ä¸­...';
            diagnosticResults = [];
            
            try {
                // 1. ç’°å¢ƒæª¢æŸ¥
                log('é–‹å§‹å®Œæ•´è¨ºæ–·...', 'info');
                await checkEnvironment();
                
                // 2. API é€£æ¥æ¸¬è©¦
                await testApiConnection();
                
                // 3. ç²å–æ¨¡æ¿æ¸¬è©¦
                await testGetTemplates();
                
                // 4. ä¿å­˜æ¨¡æ¿æ¸¬è©¦
                await testSaveTemplate();
                
                // 5. ç¸½çµ
                const successCount = diagnosticResults.filter(r => r.type === 'success').length;
                const errorCount = diagnosticResults.filter(r => r.type === 'error').length;
                const warningCount = diagnosticResults.filter(r => r.type === 'warning').length;
                
                const summary = `
ğŸ” è¨ºæ–·å®Œæˆ

ğŸ“Š çµæœçµ±è¨ˆ:
âœ… æˆåŠŸ: ${successCount}
âŒ éŒ¯èª¤: ${errorCount}
âš ï¸ è­¦å‘Š: ${warningCount}

ğŸ“‹ è©³ç´°æ—¥èªŒ:
${diagnosticResults.map(r => r.message).join('\n')}

ğŸ’¡ å»ºè­°:
${errorCount > 0 ? 'âŒ ç™¼ç¾å•é¡Œï¼Œè«‹æª¢æŸ¥ä¸Šè¿°éŒ¯èª¤è¨Šæ¯' : 'âœ… æ‰€æœ‰æ¸¬è©¦é€šéï¼Œä¿å­˜åŠŸèƒ½æ‡‰è©²æ­£å¸¸'}
                `;
                
                showResult('diagnostic-result', summary, errorCount > 0 ? 'error' : 'success');
                
            } catch (error) {
                showResult('diagnostic-result', `âŒ è¨ºæ–·å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œç’°å¢ƒæª¢æŸ¥
        window.addEventListener('load', () => {
            checkEnvironment();
        });
    </script>
</body>
</html> 